<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Number Match Game</title>
    <style>
        body {
            background-color: #202020;
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        .nes-container {
            background-color: #303030;
            border: 4px solid #fff;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
        }

        .input-group {
            margin: 15px 0;
        }

        input {
            background: #404040;
            border: 2px solid #fff;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            padding: 8px;
            width: 200px;
        }

        button {
            background: #606060;
            border: 2px solid #fff;
            color: #fff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 10px;
            padding: 8px 16px;
        }

        button:hover {
            background: #808080;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 20px auto;
        }

        .number-btn {
            aspect-ratio: 1;
            font-size: 24px;
        }

        .game-status {
            font-size: 20px;
            margin: 20px 0;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        .selected {
            background: #90EE90;  /* Player's selection - green */
            color: #000;
        }

        .opponent-selected {
            background: #87CEEB;  /* Opponent's selection - light blue */
            color: #000;
        }

        .fade-out {
            transition: all 2s ease-out;
            background: #606060 !important;
            color: #fff !important;
        }

        .moves-history {
            margin-top: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            background-color: #404040;
            border: 2px solid #fff;
            padding: 10px;
            margin: 20px auto;
            max-width: 500px;
        }

        .moves-history h3 {
            text-align: center;
            margin-top: 0;
        }

        .move-entry {
            padding: 8px;
            border-bottom: 1px solid #606060;
            font-size: 14px;
        }

        .move-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="nes-container" id="connection-form">
        <h1>Number Match Game</h1>
        <div class="input-group">
            <label for="userId">User ID:</label><br>
            <input type="number" id="userId" required>
        </div>
        <div class="input-group">
            <label for="gameId">Game ID:</label><br>
            <input type="number" id="gameId" required>
        </div>
        <button onclick="connect()">Connect</button>
    </div>

    <div class="nes-container hidden" id="game-container">
        <div class="game-status" id="game-status">Waiting for players...</div>
        
        <div class="score-board">
            <div>Your Score: <span id="your-score">0</span></div>
            <div>Opponent Score: <span id="opponent-score">0</span></div>
        </div>

        <div class="number-grid" id="number-grid">
            <button class="number-btn" onclick="selectNumber(1)">1</button>
            <button class="number-btn" onclick="selectNumber(2)">2</button>
            <button class="number-btn" onclick="selectNumber(3)">3</button>
            <button class="number-btn" onclick="selectNumber(4)">4</button>
            <button class="number-btn" onclick="selectNumber(5)">5</button>
            <button class="number-btn" onclick="selectNumber(6)">6</button>
            <button class="number-btn" onclick="selectNumber(7)">7</button>
            <button class="number-btn" onclick="selectNumber(8)">8</button>
            <button class="number-btn" onclick="selectNumber(9)">9</button>
        </div>

        <div class="moves-history">
            <h3>Game Moves</h3>
            <div id="moves-list"></div>
        </div>
    </div>

    <script>
        let ws;
        let currentUserId;
        let currentTurnId;
        let selectedNumber = null;

        function connect() {
            const userId = document.getElementById('userId').value;
            const gameId = document.getElementById('gameId').value;

            if (!userId || !gameId) {
                alert('Please enter both User ID and Game ID');
                return;
            }

            currentUserId = parseInt(userId);
            ws = new WebSocket(`ws://localhost:3001?userID=${userId}&gameID=${gameId}`);

            ws.onopen = () => {
                document.getElementById('connection-form').classList.add('hidden');
                document.getElementById('game-container').classList.remove('hidden');
                
                ws.send(JSON.stringify({
                    type: 'player-joined',
                    data: {
                        player_id: parseInt(userId)
                    }
                }));
            };

            ws.onmessage = handleMessage;
            ws.onerror = (error) => console.error('WebSocket error:', error);
            ws.onclose = () => alert('Connection closed');
        }

        function handleMessage(event) {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);

            switch (message.type) {
                case 'game-started':
                    clearSelection();
                    document.getElementById('game-status').textContent = 'Game started! Pick a number.';
                    enableNumberGrid();
                    break;

                case 'game-turn-started':
                    // Add fade-out class to all selected buttons
                    document.querySelectorAll('.selected, .opponent-selected').forEach(btn => {
                        btn.classList.add('fade-out');
                    });
                    
                    // Clear selections after transition
                    setTimeout(() => {
                        clearSelection();
                        currentTurnId = message.data.turn_id;
                        document.getElementById('game-status').textContent = `Turn ${currentTurnId}: Pick a number!`;
                        enableNumberGrid();
                    }, 2000);
                    break;

                case 'game-turn-complete':
                    handleTurnComplete(message.data);
                    break;

                case 'game-finished':
                    handleGameFinished(message.data.summary);
                    break;
            }
        }

        async function handleTurnComplete(data) {
            const turnId = data.turn_id;
            const playerGameData = data.player_game_data;
            
            // Show both players' selections
            const moves = Object.entries(playerGameData).map(([playerId, data]) => ({
                playerId: parseInt(playerId),
                selection: data.selection,
                score: data.score
            }));

            // Update moves history
            const movesList = document.getElementById('moves-list');
            const moveEntry = document.createElement('div');
            moveEntry.className = 'move-entry';
            moveEntry.innerHTML = `Turn ${turnId}: ${moves.map(move => 
                `Player ${move.playerId} chose ${move.selection}`
            ).join(' | ')}`;
            movesList.insertBefore(moveEntry, movesList.firstChild);

            // Highlight opponent's selection
            moves.forEach(move => {
                if (move.playerId !== currentUserId) {
                    const btn = document.querySelector(`.number-btn:nth-child(${move.selection})`);
                    btn.classList.add('opponent-selected');
                }
            });

            // Update scores
            const scores = Object.fromEntries(
                Object.entries(playerGameData).map(([playerId, data]) => [playerId, data.score])
            );
            updateScores(scores);

            // Disable grid during delay
            disableNumberGrid();
            document.getElementById('game-status').textContent = 'Showing results...';
        }

        function selectNumber(number) {
            if (!currentTurnId) return;

            selectedNumber = number;
            
            // Update UI to show selection
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.remove('selected', 'opponent-selected', 'fade-out');
                if (parseInt(btn.textContent) === number) {
                    btn.classList.add('selected');
                }
            });

            // Send player turn event
            ws.send(JSON.stringify({
                type: 'player-turn',
                data: {
                    player_id: currentUserId,
                    turn_id: currentTurnId,
                    selection: number
                }
            }));

            // Disable number grid after selection
            disableNumberGrid();
            document.getElementById('game-status').textContent = 'Waiting for opponent...';
        }

        function updateScores(scores) {
            const yourScore = scores[currentUserId] || 0;
            const opponentId = Object.keys(scores).find(id => parseInt(id) !== currentUserId);
            const opponentScore = opponentId ? scores[opponentId] : 0;

            document.getElementById('your-score').textContent = yourScore;
            document.getElementById('opponent-score').textContent = opponentScore;
        }

        function handleGameFinished(summary) {
            let message = '';
            if (summary.status === 'draw') {
                message = "Game Over - It's a draw!";
            } else {
                message = summary.winner === currentUserId ? 
                    'Game Over - You won!' : 
                    'Game Over - Opponent won!';
            }
            document.getElementById('game-status').textContent = message;
            disableNumberGrid();
        }

        function enableNumberGrid() {
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.disabled = false;
            });
        }

        function disableNumberGrid() {
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        function clearSelection() {
            selectedNumber = null;
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.remove('selected', 'opponent-selected', 'fade-out');
            });
        }
    </script>
</body>
</html>